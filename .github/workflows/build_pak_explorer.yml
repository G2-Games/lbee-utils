name: Publish PAK Explorer on release

on:
  workflow_dispatch:
  push:
    tags: [ 'explorer-*.*.*' ]

env:
    BINARIES: "--bin pak_explorer"

permissions:
  contents: write

jobs:
    build:
        name: Build binaries for Windows and Linux
        runs-on: ubuntu-latest
        steps:
        - name: 'ðŸ“„ Checkout'
          uses: actions/checkout@v4

        - name: 'âš™ï¸ Set up Rust environment'
          uses: dtolnay/rust-toolchain@master
          with:
              toolchain: stable
              targets: x86_64-pc-windows-gnu, i686-pc-windows-gnu, x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu

        - name: 'ðŸ”½ Cache Rust dependencies'
          uses: actions/cache@v4
          with:
              path: target
              key: ${{ runner.OS }}-build-${{ hashFiles('**/Cargo.lock') }}
              restore-keys: |
                  ${{ runner.OS }}-build-

        - name: 'ðŸ”„ Set up additional requirements'
          run: |
            sudo apt-get update -y
            sudo apt-get install -y gcc-mingw-w64
            sudo apt-get install -y libasound2t64
            sudo apt-get install -y libasound2-dev
            sudo apt-get install -y libudev-dev
            pip install cargo-zigbuild

        - name: 'ðŸ“¦ Package Windows x86_64'
          run: |
              cd ${{github.workspace}}
              cargo build --profile production --target x86_64-pc-windows-gnu $BINARIES
              cp target/x86_64-pc-windows-gnu/production/pak_explorer.exe PAK-Explorer_Windows-x86_64.exe
              gh release upload ${{ github.ref_name }} PAK-Explorer_Windows-x86_64.exe
          env:
              GITHUB_TOKEN: ${{ github.TOKEN }}
          shell: bash

        - name: 'ðŸ“¦ Package Windows i686'
          run: |
              cd ${{github.workspace}}
              cargo build --profile production --target i686-pc-windows-gnu $BINARIES
              cp target/i686-pc-windows-gnu/production/pak_explorer.exe PAK-Explorer_Windows-x86.exe
              gh release upload ${{ github.ref_name }} PAK-Explorer_Windows-x86.exe
          env:
              GITHUB_TOKEN: ${{ github.TOKEN }}
          shell: bash

        - name: 'ðŸ“¦ Package Linux x86_64'
          run: |
              cd ${{github.workspace}}
              cargo build --profile production --target x86_64-unknown-linux-gnu $BINARIES
              cp target/x86_64-unknown-linux-gnu/production/pak_explorer PAK-Explorer_Linux-x86_64
              gh release upload ${{ github.ref_name }} PAK-Explorer_Linux-x86_64
          env:
              GITHUB_TOKEN: ${{ github.TOKEN }}
          shell: bash

    build-mac:
        name: Build binaries for MacOS
        runs-on: macos-14
        steps:
        - name: 'ðŸ“„ Checkout'
          uses: actions/checkout@v4

        - name: 'âš™ï¸ Set up Rust environment'
          uses: dtolnay/rust-toolchain@master
          with:
              toolchain: stable
              targets: x86_64-apple-darwin, aarch64-apple-darwin

        - name: 'ðŸ”½ Cache Rust dependencies'
          uses: actions/cache@v4
          with:
              path: target
              key: ${{ runner.OS }}-build-${{ hashFiles('**/Cargo.lock') }}
              restore-keys: |
                  ${{ runner.OS }}-build-

        - name: 'ðŸ”„ Set up additional requirements'
          run: |
            brew install zig
            brew install portaudio
            cargo install --locked cargo-zigbuild

        - name: 'ðŸ§­ Point bindgen to macOS SDK'
          run: |
            SDK="$(xcrun --sdk macosx --show-sdk-path)"
            {
              echo "SDKROOT=$SDK"
              echo "COREAUDIO_SDK_PATH=$SDK"
              echo "BINDGEN_EXTRA_CLANG_ARGS=-isysroot $SDK"
            } >> "$GITHUB_ENV"


        - name: 'ðŸ“¦ Package MacOS Universal2'
          run: |
              cd ${{github.workspace}}
              cargo zigbuild --manifest-path "pak_explorer/Cargo.toml" --profile production --target universal2-apple-darwin $BINARIES
              cp target/universal2-apple-darwin/production/pak_explorer PAK-Explorer_Mac-Universal
              gh release upload ${{ github.ref_name }} PAK-Explorer_Mac-Universal
          env:
              GITHUB_TOKEN: ${{ github.TOKEN }}
          shell: bash
